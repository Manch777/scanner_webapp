<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Сканер QR-кодов</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-align:center; padding:20px; }
    h2 { margin-bottom: 10px; }
    #preview { margin: 12px 0; font-size: 16px; color: #333; min-height: 1.5em; }
    video { border: 1px solid #ccc; border-radius: 8px; width: 100%; max-width: 720px; height: auto; }
    .hint { font-size: 12px; color: #777; margin-top: 10px; }
  </style>
  <!-- Обязательно подключаем Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- ZXing для сканирования -->
  <script type="module">
    import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

    // Если страницу кто-то открыл не из Telegram, можно включить запасной deep-link
    const BOT_USERNAME_FALLBACK = "Test_zhazhda_bot"; // без @, только для отладки/вне Telegram

    document.addEventListener("DOMContentLoaded", () => {
      const previewElem = document.getElementById("preview");
      const videoElem = document.getElementById("video-preview");

      // Делаем WebApp готовым (устанавливает тему и пр.)
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
      }

      const codeReader = new BrowserQRCodeReader();

      async function sendToTelegram(payload) {
        try {
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.sendData(payload);           // <-- ключевая строка
            previewElem.innerText = "✅ Данные отправлены в Telegram. Окно можно закрыть.";
            // Чуть-чуть подождём и закроем
            setTimeout(() => {
              try { Telegram.WebApp.close(); } catch (_) {}
            }, 300);
          } else {
            // Фолбэк: не в Telegram — откроем бота обычным deep-link (на случай тестов в браузере)
            window.location.href = `https://t.me/${BOT_USERNAME_FALLBACK}?start=${encodeURIComponent(payload)}`;
          }
        } catch (e) {
          console.error(e);
          previewElem.innerText = "❌ Ошибка отправки в Telegram: " + (e?.message || e);
        }
      }

      async function startScanner() {
        try {
          // Список камер
          const devices = await BrowserQRCodeReader.listVideoInputDevices();
          if (!devices || devices.length === 0) {
            previewElem.innerText = "❌ Камера недоступна. Проверьте разрешения и HTTPS.";
            return;
          }

          // Выбираем тыловую камеру, если найдётся
          const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];

          previewElem.innerText = "Камера активна. Наведите на QR-код...";

          // Сканируем РОВНО один код и останавливаемся
          const result = await codeReader.decodeOnceFromVideoDevice(backCam.deviceId, videoElem);
          let payload = (result?.getText?.() || "").trim();

          if (!payload) {
            previewElem.innerText = "⚠️ Пустой QR.";
            await codeReader.reset();
            return;
          }

          // (необязательно) Если хотите, можете привести формат:
          // Например, если в QR только число и вы хотите всегда слать как row_id:
          // if (/^\d+$/.test(payload)) payload = `R:${payload}`;

          previewElem.innerText = "✅ QR считан. Отправляем...";
          await codeReader.reset(); // останавливаем камеру
          await sendToTelegram(payload);
        } catch (err) {
          console.error("Ошибка сканирования:", err);
          previewElem.innerText = "❌ Ошибка сканирования: " + (err?.message || err);
          try { await codeReader.reset(); } catch (_) {}
        }
      }

      startScanner();
    });
  </script>
</head>
<body>
  <h2>Сканируйте QR-код</h2>
  <div id="preview">Запрашиваем доступ к камере…</div>
  <video id="video-preview" autoplay muted playsinline></video>
  <div class="hint">Страница должна открываться из Telegram-кнопки с <code>web_app</code>.</div>
</body>
</html>

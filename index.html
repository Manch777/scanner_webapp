<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Сканер QR-кодов</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-align:center; padding:20px; }
    h2 { margin-bottom: 10px; }
    #preview { margin: 12px 0; font-size: 16px; color: #333; min-height: 1.5em; }
    video { border: 1px solid #ccc; border-radius: 8px; width: 100%; max-width: 720px; height: auto; }
    .hint { font-size: 12px; color: #777; margin-top: 10px; }
  </style>
  <!-- Обязательно подключаем Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- ZXing для сканирования -->
<script type="module">
  import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

  const previewElem = document.getElementById("preview");
  const videoElem   = document.getElementById("video-preview");

  if (window.Telegram?.WebApp) Telegram.WebApp.ready();

  const reader = new BrowserQRCodeReader();

  async function sendToTelegram(payload) {
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.sendData(payload);
      previewElem.textContent = "✅ Отправлено в Telegram, можно закрыть окно.";
      setTimeout(() => { try { Telegram.WebApp.close(); } catch {} }, 300);
    }
  }

  try {
    const devices = await BrowserQRCodeReader.listVideoInputDevices();
    if (!devices.length) {
      previewElem.textContent = "❌ Камера недоступна.";
      return;
    }
    const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
    previewElem.textContent = "Камера активна. Наведите на QR…";

    // Стартуем сканирование с коллбэком и получаем controls
    const controls = await reader.decodeFromVideoDevice(backCam.deviceId, videoElem, (result, err) => {
      if (result) {
        const payload = (result.getText() || "").trim();
        controls.stop();              // <-- корректно останавливаем камеру
        sendToTelegram(payload);      // <-- отправляем в бота
      }
      // ошибки в err можно игнорировать — они сыпятся пока детектор ищет код
    });
  } catch (e) {
    console.error(e);
    previewElem.textContent = "❌ Ошибка сканирования: " + (e?.message || e);
  }
</script>
</head>
<body>
  <h2>Сканируйте QR-код</h2>
  <div id="preview">Запрашиваем доступ к камере…</div>
  <video id="video-preview" autoplay muted playsinline></video>
  <div class="hint">Страница должна открываться из Telegram-кнопки с <code>web_app</code>.</div>
</body>
</html>

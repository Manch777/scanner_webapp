<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сканер QR-кодов</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; text-align: center; }
    video { width: 100%; max-width: 720px; border: 1px solid #ddd; border-radius: 8px; }
    #start { padding: 10px 16px; font-size: 16px; border-radius: 8px; border: none; }
    #preview { margin: 12px 0; color: #333; }
  </style>

  <script type="module">
    import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm";

    const preview = document.getElementById('preview');
    const video   = document.getElementById('video');
    const btn     = document.getElementById('start');

    if (window.Telegram?.WebApp) Telegram.WebApp.ready();

    const reader = new BrowserQRCodeReader();
    let controls = null;

    function finish(payload) {
      // 1) Отправляем в бота
      try { Telegram?.WebApp?.sendData(payload); } catch {}
      // 2) Останавливаем камеру
      try { controls?.stop(); } catch {}
      // 3) Небольшая вибрация и закрываем мини-приложение
      try { Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success'); } catch {}
      // Небольшая задержка на отправку
      setTimeout(() => {
        try { Telegram?.WebApp?.close(); } catch { window.close(); }
      }, 100);
      preview.textContent = "✅ Отправлено, закрываю…";
    }

    async function startScan() {
      preview.textContent = "Запрашиваю доступ к камере…";
      btn.disabled = true;

      try {
        // Явно вызываем системный запрос доступа (важно для iOS)
        await navigator.mediaDevices.getUserMedia({ video: true }).then(s => s.getTracks().forEach(t => t.stop())).catch(()=>{});

        preview.textContent = "Камера активна. Наведите на QR…";

        // Сканируем с тыльной камеры, без reset()
        controls = await reader.decodeFromConstraints(
          { video: { facingMode: { ideal: "environment" } } },
          video,
          (result, err) => {
            if (result) {
              const text = (result.getText() || "").trim();
              finish(text); // ← вот здесь отправка и закрытие
            }
          }
        );
      } catch (e) {
        console.error(e);
        if (e?.name === "NotAllowedError") {
          preview.textContent = "⚠️ Доступ к камере запрещён. Разрешите камеру и откройте заново.";
        } else if (e?.name === "NotFoundError") {
          preview.textContent = "❌ Камера не найдена.";
        } else {
          preview.textContent = "❌ Ошибка: " + (e?.message || e);
        }
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', startScan);
  </script>
</head>
<body>
  <h2>Сканируйте QR-код</h2>
  <div id="preview">Нажмите «Начать», чтобы дать доступ к камере.</div>
  <button id="start">Начать сканирование</button>
  <div style="margin:12px 0;"></div>
  <video id="video" playsinline autoplay muted></video>
  <p style="opacity:.6">Открывайте эту страницу из Telegram-кнопки с <code>web_app</code>.</p>
</body>
</html>
